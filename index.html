<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>เงินเข้า-ออก & หนี้ (Thai Finance & Debt Tracker)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111b2e;
      --card2:#0f1930;
      --text:#e8eefc;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.10);
      --good:#3ddc97;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --accent:#7aa2ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --pad:14px;
      --max: 980px;
      --tap: 46px;
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(122,162,255,.22), transparent 55%),
                  radial-gradient(900px 500px at 100% 10%, rgba(61,220,151,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .app{
      max-width: var(--max);
      margin: 0 auto;
      padding: env(safe-area-inset-top) 14px calc(14px + env(safe-area-inset-bottom)) 14px;
    }
    header{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.70);
      border-bottom: 1px solid var(--line);
      margin: 0 -14px 12px -14px;
      padding: 12px 14px;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand b{font-size:16px; letter-spacing:.2px}
    .brand small{color:var(--muted)}
    .actions{display:flex; gap:8px; align-items:center}
    button, .btn{
      height: var(--tap);
      padding: 0 14px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform: translateY(1px)}
    .btn-primary{
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.65));
      border-color: rgba(122,162,255,.55);
      color:#07102a;
    }
    .btn-danger{
      background: rgba(255,92,122,.12);
      border-color: rgba(255,92,122,.35);
      color: var(--text);
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }

    .grid{
      display:grid;
      gap:12px;
    }
    @media(min-width:860px){
      .grid.two{grid-template-columns: 1.2fr .8fr}
      .grid.cards{grid-template-columns: repeat(3,1fr)}
      .grid.charts{grid-template-columns: 1fr 1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
      overflow:hidden;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size: 14px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing:.2px;
      text-transform:none;
    }
    .hero{
      display:flex;
      gap:12px;
      align-items: baseline;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .hero .value{
      font-size: 34px;
      font-weight: 900;
      letter-spacing: .2px;
      line-height:1.05;
    }
    .hero .sub{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }
    .hero .delta{
      font-size: 12px;
      color: var(--muted);
    }
    .value.good{color: var(--good)}
    .value.bad{color: var(--bad)}
    .value.warn{color: var(--warn)}

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 0;
      border-top:1px dashed rgba(255,255,255,.10);
    }
    .row:first-of-type{border-top:none}
    .row .label{
      color: var(--muted);
      font-size: 13px;
    }
    .row .amt{
      font-weight: 800;
    }

    .tabs{
      position: sticky;
      bottom: 0;
      z-index: 20;
      margin: 14px -14px 0 -14px;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px;
      border-top: 1px solid var(--line);
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.75);
    }
    .tabbar{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }
    .tab{
      height: 48px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.35);
      color: var(--text);
    }

    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sectionTitle h1{
      font-size: 16px;
      margin: 0;
      letter-spacing:.2px;
    }

    .form{
      display:grid;
      gap:10px;
    }
    label{
      display:grid;
      gap:6px;
      font-size: 13px;
      color: var(--muted);
    }
    input, select, textarea{
      width:100%;
      min-height: var(--tap);
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-size: 15px;
    }
    textarea{min-height: 84px; resize: vertical}
    input::placeholder, textarea::placeholder{color: rgba(169,183,214,.55)}
    .twoCol{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }

    .list{
      display:grid;
      gap:8px;
      margin-top:10px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.04);
    }
    .item .left{
      display:grid;
      gap:2px;
      min-width: 0;
    }
    .item .left b{
      font-size: 14px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .item .left small{color: var(--muted)}
    .item .right{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .iconBtn{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
    }
    .iconBtn.danger{
      background: rgba(255,92,122,.10);
      border-color: rgba(255,92,122,.30);
    }

    .hint{
      color: var(--muted);
      font-size: 12px;
      line-height:1.4;
    }
    .divider{
      height:1px;
      background: var(--line);
      margin: 10px 0;
    }

    canvas{width:100%; height: 220px; display:block}
    .chartWrap{
      display:grid;
      gap:8px;
    }
    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
    }
    .dot{
      width:10px; height:10px; border-radius: 99px; display:inline-block; margin-right:6px;
      border:1px solid rgba(255,255,255,.25);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%);
      background: rgba(17,27,46,.92);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-weight: 700;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }
    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="topbar">
        <div class="brand">
          <b>เงินเข้า-ออก & หนี้</b>
          <small id="lastSaved">ยังไม่บันทึก</small>
        </div>
        <div class="actions">
          <span class="pill" id="monthLabel"></span>
          <button class="btn-danger" id="resetBtn" type="button">ล้างข้อมูล</button>
        </div>
      </div>
    </header>

    <!-- Views -->
    <main id="viewRoot"></main>

    <!-- Bottom tabs -->
    <div class="tabs">
      <div class="tabbar">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="income">Income</div>
        <div class="tab" data-tab="debts">Debts</div>
        <div class="tab" data-tab="plan">Plan</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){
      "use strict";

      // ---------- Utilities ----------
      const $ = (sel, el=document) => el.querySelector(sel);
      const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

      const STORAGE_KEY = "thai_finance_debt_tracker_v1";

      function nowISO(){
        const d = new Date();
        const pad = n => String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function toNumber(v){
        if (typeof v === "number") return isFinite(v) ? v : 0;
        if (!v) return 0;
        const s = String(v).replace(/[^\d.-]/g,"");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }

      function formatTHB(n){
        const x = Math.round(toNumber(n));
        return x.toLocaleString("th-TH") + " ฿";
      }

      function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

      function showToast(msg){
        const t = $("#toast");
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(showToast._timer);
        showToast._timer = setTimeout(()=>t.classList.remove("show"), 1400);
      }

      function uid(){
        return Math.random().toString(16).slice(2) + Date.now().toString(16);
      }

      // ---------- Data Model ----------
      const defaultState = {
        meta: { lastSaved: null },
        settings: {
          month: new Date().toISOString().slice(0,7), // YYYY-MM
          currency: "THB"
        },
        incomeMonthly: 0,
        fixedExpenses: [
          // {id, name, amount}
          { id: uid(), name: "ค่าเช่า/ผ่อนบ้าน", amount: 0 },
          { id: uid(), name: "ค่าน้ำ/ไฟ", amount: 0 }
        ],
        debts: [
          // {id, type, name, balance, apr, minPayment, dueDay, note}
          // type: "credit" | "installment"
        ]
      };

      const store = {
        load(){
          try{
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return structuredClone(defaultState);
            const parsed = JSON.parse(raw);

            // Backfill missing keys safely
            const st = structuredClone(defaultState);
            Object.assign(st, parsed || {});
            st.meta = Object.assign(st.meta, parsed?.meta || {});
            st.settings = Object.assign(st.settings, parsed?.settings || {});
            st.fixedExpenses = Array.isArray(parsed?.fixedExpenses) ? parsed.fixedExpenses : st.fixedExpenses;
            st.debts = Array.isArray(parsed?.debts) ? parsed.debts : st.debts;

            // Ensure ids exist
            st.fixedExpenses = st.fixedExpenses.map(x => ({ id: x.id || uid(), name: x.name || "รายการ", amount: toNumber(x.amount) }));
            st.debts = st.debts.map(d => ({
              id: d.id || uid(),
              type: d.type === "installment" ? "installment" : "credit",
              name: d.name || (d.type === "installment" ? "สินเชื่อ/ผ่อนสินค้า" : "บัตรเครดิต"),
              balance: toNumber(d.balance),
              apr: toNumber(d.apr),
              minPayment: toNumber(d.minPayment),
              dueDay: clamp(Math.floor(toNumber(d.dueDay || 1)), 1, 31),
              note: d.note || ""
            }));
            st.incomeMonthly = toNumber(st.incomeMonthly);
            return st;
          }catch(e){
            console.warn("Load failed, using default", e);
            return structuredClone(defaultState);
          }
        },
        save(state){
          state.meta.lastSaved = nowISO();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        },
        reset(){
          localStorage.removeItem(STORAGE_KEY);
        }
      };

      let state = store.load();

      // ---------- Computations ----------
      function totals(){
        const income = toNumber(state.incomeMonthly);
        const fixedTotal = state.fixedExpenses.reduce((s,x)=>s + toNumber(x.amount), 0);
        const debtMinTotal = state.debts.reduce((s,d)=>s + toNumber(d.minPayment), 0);
        const left = income - fixedTotal - debtMinTotal;
        const debtBalanceTotal = state.debts.reduce((s,d)=>s + toNumber(d.balance), 0);
        return { income, fixedTotal, debtMinTotal, left, debtBalanceTotal };
      }

      function cashTone(left){
        if (left >= 3000) return "good";
        if (left >= 0) return "warn";
        return "bad";
      }

      function dueStatus(dueDay){
        // Compare dueDay with today's day, rough indicator (no backend, per-month UI)
        const today = new Date().getDate();
        const diff = dueDay - today;
        if (diff < 0) return { label: "เลยกำหนด", color: "var(--bad)" };
        if (diff <= 3) return { label: "ใกล้ถึงกำหนด", color: "var(--warn)" };
        return { label: "ปกติ", color: "var(--good)" };
      }

      // ---------- Rendering ----------
      const viewRoot = $("#viewRoot");

      function setMonthLabel(){
        const m = state.settings.month || new Date().toISOString().slice(0,7);
        const [yy, mm] = m.split("-");
        const thMonths = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];
        const label = `${thMonths[(+mm)-1]} ${(+yy)+543}`;
        $("#monthLabel").textContent = label;
      }

      function setLastSaved(){
        const s = state.meta.lastSaved;
        $("#lastSaved").textContent = s ? `บันทึกล่าสุด: ${s}` : "ยังไม่บันทึก";
      }

      function renderDashboard(){
        const t = totals();
        const tone = cashTone(t.left);

        const debtsSorted = [...state.debts].sort((a,b)=>toNumber(b.balance)-toNumber(a.balance));

        viewRoot.innerHTML = `
          <div class="grid two">
            <section class="card">
              <h2>เงินคงเหลือปลายเดือน</h2>
              <div class="hero">
                <div>
                  <div class="value ${tone}">${formatTHB(t.left)}</div>
                  <div class="sub">คำนวณจาก รายรับ - รายจ่ายคงที่ - ยอดชำระหนี้ขั้นต่ำ</div>
                </div>
                <div class="pill">อัปเดตแบบออฟไลน์ (localStorage)</div>
              </div>

              <div class="divider"></div>

              <div class="row">
                <div class="label">รายรับต่อเดือน</div>
                <div class="amt">${formatTHB(t.income)}</div>
              </div>
              <div class="row">
                <div class="label">รายจ่ายคงที่รวม</div>
                <div class="amt">${formatTHB(t.fixedTotal)}</div>
              </div>
              <div class="row">
                <div class="label">ชำระหนี้ขั้นต่ำรวม</div>
                <div class="amt">${formatTHB(t.debtMinTotal)}</div>
              </div>
              <div class="row">
                <div class="label">ยอดหนี้คงค้างรวม</div>
                <div class="amt">${formatTHB(t.debtBalanceTotal)}</div>
              </div>

              <div class="divider"></div>
              <div class="hint">
                ทิป: ถ้า “เงินคงเหลือ” ติดลบ ให้เริ่มจากลดรายจ่ายคงที่ หรือเพิ่มการจ่ายหนี้แบบจัดลำดับ (ดูแท็บ Plan)
              </div>
            </section>

            <section class="grid cards">
              <div class="card">
                <h2>Action</h2>
                <div class="form">
                  <button class="btn-primary" type="button" id="goIncome">แก้ไขรายรับ/รายจ่าย</button>
                  <button class="btn-primary" type="button" id="goDebts">เพิ่ม/แก้ไขหนี้</button>
                </div>
                <div class="divider"></div>
                <div class="hint">ทุกอย่างบันทึกอัตโนมัติบนเครื่องของคุณ</div>
              </div>

              <div class="card">
                <h2>หนี้ใกล้ถึงกำหนด</h2>
                <div class="list" id="dueList"></div>
                <div class="hint" id="dueHint"></div>
              </div>

              <div class="card">
                <h2>สรุปเร็ว</h2>
                <div class="hint">ถ้าไม่มีหนี้ ลองเพิ่มเป้าหมายเงินเก็บใน Plan</div>
                <div class="divider"></div>
                <div class="row">
                  <div class="label">จำนวนรายการรายจ่ายคงที่</div>
                  <div class="amt">${state.fixedExpenses.length}</div>
                </div>
                <div class="row">
                  <div class="label">จำนวนหนี้ทั้งหมด</div>
                  <div class="amt">${state.debts.length}</div>
                </div>
              </div>
            </section>
          </div>

          <div class="grid charts" style="margin-top:12px">
            <section class="card">
              <div class="sectionTitle">
                <h1>ภาพรวมเงิน (Pie)</h1>
                <span class="pill">Fixed / Debt / Left</span>
              </div>
              <div class="chartWrap">
                <canvas id="pieChart" width="640" height="260" aria-label="Spending pie chart"></canvas>
                <div class="legend" id="pieLegend"></div>
              </div>
            </section>

            <section class="card">
              <div class="sectionTitle">
                <h1>ยอดหนี้คงค้าง (Bar)</h1>
                <span class="pill">ตามรายการหนี้</span>
              </div>
              <div class="chartWrap">
                <canvas id="barChart" width="640" height="260" aria-label="Debt bar chart"></canvas>
                <div class="hint" id="barHint"></div>
              </div>
            </section>
          </div>
        `;

        // Due list
        const dueList = $("#dueList");
        const soon = state.debts
          .map(d => ({...d, status: dueStatus(d.dueDay)}))
          .sort((a,b)=>{
            // overdue first, then closest
            const da = a.dueDay - new Date().getDate();
            const db = b.dueDay - new Date().getDate();
            return da - db;
          })
          .slice(0,4);

        if (soon.length === 0){
          $("#dueHint").textContent = "ยังไม่มีหนี้ในระบบ";
        } else {
          dueList.innerHTML = soon.map(d => {
            return `
              <div class="item">
                <div class="left">
                  <b>${escapeHTML(d.name)}</b>
                  <small>กำหนดชำระวันที่ ${d.dueDay} • ${d.type === "credit" ? "บัตรเครดิต" : "ผ่อน/สินเชื่อ"}</small>
                </div>
                <div class="right">
                  <span class="pill" style="border-color: ${d.status.color}; color:${d.status.color}">${d.status.label}</span>
                </div>
              </div>
            `;
          }).join("");
          $("#dueHint").textContent = "";
        }

        // Buttons
        $("#goIncome").addEventListener("click", ()=>setTab("income"));
        $("#goDebts").addEventListener("click", ()=>setTab("debts"));

        // Charts
        drawMoneyPieChart($("#pieChart"), $("#pieLegend"));
        drawDebtBarChart($("#barChart"), $("#barHint"));
      }

      function renderIncome(){
        const t = totals();

        viewRoot.innerHTML = `
          <div class="card">
            <div class="sectionTitle">
              <h1>รายรับ & รายจ่ายคงที่</h1>
              <span class="pill">บันทึกอัตโนมัติ</span>
            </div>

            <div class="form">
              <label>
                รายรับต่อเดือน (บาท)
                <input id="incomeInput" inputmode="numeric" placeholder="เช่น 35000" value="${state.incomeMonthly ? String(state.incomeMonthly) : ""}">
              </label>

              <div class="divider"></div>

              <div class="sectionTitle">
                <h1>รายการรายจ่ายคงที่</h1>
                <button class="btn" type="button" id="addFixed">+ เพิ่มรายการ</button>
              </div>

              <div class="list" id="fixedList"></div>

              <div class="divider"></div>

              <div class="row">
                <div class="label">รวมรายจ่ายคงที่</div>
                <div class="amt">${formatTHB(t.fixedTotal)}</div>
              </div>

              <div class="hint">ตัวอย่างรายจ่ายคงที่: ค่าเช่า/ผ่อนบ้าน, ค่าน้ำไฟ, ค่าโทรศัพท์, ค่าเดินทาง, สมาชิก/ประกัน</div>
            </div>
          </div>
        `;

        const incomeInput = $("#incomeInput");
        incomeInput.addEventListener("input", ()=>{
          state.incomeMonthly = toNumber(incomeInput.value);
          autosave();
          // Keep view summary fresh (cheap re-render)
          renderIncome();
          incomeInput.focus();
          incomeInput.setSelectionRange(incomeInput.value.length, incomeInput.value.length);
        });

        const fixedList = $("#fixedList");
        fixedList.innerHTML = state.fixedExpenses.map(x => fixedRowHTML(x)).join("");

        $$("#fixedList .item").forEach(el=>{
          const id = el.getAttribute("data-id");
          const nameEl = el.querySelector(".fx-name");
          const amtEl = el.querySelector(".fx-amt");
          const delEl = el.querySelector(".fx-del");

          nameEl.addEventListener("input", ()=>{
            const it = state.fixedExpenses.find(a=>a.id===id);
            if (!it) return;
            it.name = nameEl.value.trim() || "รายการ";
            autosave();
          });

          amtEl.addEventListener("input", ()=>{
            const it = state.fixedExpenses.find(a=>a.id===id);
            if (!it) return;
            it.amount = toNumber(amtEl.value);
            autosave();
            // refresh totals without losing editing context: minimal re-render for totals only
            // simplest MVP: full re-render
            renderIncome();
            // restore focus
            const restored = document.querySelector(`[data-id="${cssEscape(id)}"] .fx-amt`);
            if (restored){
              restored.focus();
              restored.setSelectionRange(restored.value.length, restored.value.length);
            }
          });

          delEl.addEventListener("click", ()=>{
            state.fixedExpenses = state.fixedExpenses.filter(a=>a.id!==id);
            autosave();
            renderIncome();
          });
        });

        $("#addFixed").addEventListener("click", ()=>{
          state.fixedExpenses.unshift({ id: uid(), name: "รายการใหม่", amount: 0 });
          autosave();
          renderIncome();
          const first = $("#fixedList .fx-name");
          if (first) first.focus();
        });
      }

      function fixedRowHTML(x){
        return `
          <div class="item" data-id="${x.id}">
            <div class="left" style="width:100%">
              <label class="sr-only">ชื่อรายการ</label>
              <input class="fx-name" value="${escapeHTMLAttr(x.name)}" placeholder="ชื่อรายการ เช่น ค่าเช่า" />
              <small>จำนวนเงิน (บาท)</small>
              <input class="fx-amt" inputmode="numeric" value="${x.amount ? String(x.amount) : ""}" placeholder="เช่น 8000" />
            </div>
            <div class="right">
              <button class="iconBtn danger fx-del" type="button" title="ลบ">✕</button>
            </div>
          </div>
        `;
      }

      function renderDebts(){
        viewRoot.innerHTML = `
          <div class="card">
            <div class="sectionTitle">
              <h1>หนี้ (บัตรเครดิต/ผ่อน/สินเชื่อ)</h1>
              <button class="btn" type="button" id="addDebt">+ เพิ่มหนี้</button>
            </div>

            <div class="hint">
              กรอก “ยอดชำระขั้นต่ำ” เพื่อให้ Dashboard คำนวณเงินคงเหลือได้ทันที<br>
              (ถ้าไม่แน่ใจ ให้ใส่ยอดที่ต้องจ่ายต่อเดือน)
            </div>

            <div class="divider"></div>

            <div class="list" id="debtList"></div>
          </div>
        `;

        const list = $("#debtList");
        if (state.debts.length === 0){
          list.innerHTML = `<div class="hint">ยังไม่มีหนี้ — กด “เพิ่มหนี้” เพื่อเริ่ม</div>`;
        } else {
          list.innerHTML = state.debts
            .map(d => debtCardHTML(d))
            .join("");
        }

        // Wire events
        $$("#debtList .debt").forEach(card=>{
          const id = card.getAttribute("data-id");
          const get = () => state.debts.find(x=>x.id===id);

          const typeEl = card.querySelector(".d-type");
          const nameEl = card.querySelector(".d-name");
          const balEl  = card.querySelector(".d-balance");
          const aprEl  = card.querySelector(".d-apr");
          const minEl  = card.querySelector(".d-min");
          const dueEl  = card.querySelector(".d-due");
          const noteEl = card.querySelector(".d-note");
          const delEl  = card.querySelector(".d-del");

          const onAny = ()=>{
            const d = get(); if (!d) return;
            d.type = typeEl.value === "installment" ? "installment" : "credit";
            d.name = nameEl.value.trim() || (d.type === "installment" ? "สินเชื่อ/ผ่อนสินค้า" : "บัตรเครดิต");
            d.balance = toNumber(balEl.value);
            d.apr = toNumber(aprEl.value);
            d.minPayment = toNumber(minEl.value);
            d.dueDay = clamp(Math.floor(toNumber(dueEl.value || 1)), 1, 31);
            d.note = noteEl.value || "";
            autosave();
          };

          [typeEl, nameEl, balEl, aprEl, minEl, dueEl, noteEl].forEach(el=>{
            el.addEventListener("input", onAny);
            el.addEventListener("change", onAny);
          });

          delEl.addEventListener("click", ()=>{
            state.debts = state.debts.filter(x=>x.id!==id);
            autosave();
            renderDebts();
          });
        });

        $("#addDebt").addEventListener("click", ()=>{
          state.debts.unshift({
            id: uid(),
            type: "credit",
            name: "บัตรเครดิต",
            balance: 0,
            apr: 16,
            minPayment: 0,
            dueDay: 25,
            note: ""
          });
          autosave();
          renderDebts();
          const first = $("#debtList .d-name");
          if (first) first.focus();
        });
      }

      function debtCardHTML(d){
        const st = dueStatus(d.dueDay);
        return `
          <div class="item debt" data-id="${d.id}" style="flex-direction:column; align-items:stretch">
            <div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between; width:100%">
              <div class="left" style="width:100%">
                <div class="twoCol">
                  <label>
                    ประเภท
                    <select class="d-type">
                      <option value="credit" ${d.type==="credit"?"selected":""}>บัตรเครดิต</option>
                      <option value="installment" ${d.type==="installment"?"selected":""}>ผ่อน/สินเชื่อ</option>
                    </select>
                  </label>
                  <label>
                    ชื่อหนี้
                    <input class="d-name" placeholder="เช่น KBank Card / ผ่อนมือถือ" value="${escapeHTMLAttr(d.name)}" />
                  </label>
                </div>

                <div class="twoCol">
                  <label>
                    ยอดคงค้าง (บาท)
                    <input class="d-balance" inputmode="numeric" placeholder="เช่น 25000" value="${d.balance?String(d.balance):""}" />
                  </label>
                  <label>
                    ยอดชำระขั้นต่ำ/ต่อเดือน (บาท)
                    <input class="d-min" inputmode="numeric" placeholder="เช่น 1500" value="${d.minPayment?String(d.minPayment):""}" />
                  </label>
                </div>

                <div class="twoCol">
                  <label>
                    ดอกเบี้ยต่อปี (APR %)
                    <input class="d-apr" inputmode="decimal" placeholder="เช่น 16" value="${d.apr?String(d.apr):""}" />
                  </label>
                  <label>
                    กำหนดชำระ (วันที่ 1-31)
                    <input class="d-due" inputmode="numeric" placeholder="เช่น 25" value="${d.dueDay?String(d.dueDay):""}" />
                  </label>
                </div>

                <label>
                  โน้ต (ไม่บังคับ)
                  <textarea class="d-note" placeholder="เช่น จ่ายก่อนวันที่ 25 ทุกเดือน">${escapeHTML(d.note||"")}</textarea>
                </label>

                <div class="legend">
                  <span class="pill" style="border-color:${st.color}; color:${st.color}">สถานะ: ${st.label}</span>
                </div>
              </div>

              <div class="right">
                <button class="iconBtn danger d-del" type="button" title="ลบหนี้">✕</button>
              </div>
            </div>
          </div>
        `;
      }

      function renderPlan(){
        const t = totals();
        const extra = Math.max(0, t.left); // only positive leftover for payoff
        const debts = [...state.debts].map(d=>({
          ...d,
          // rough monthly interest estimate
          estInterest: toNumber(d.balance) * (toNumber(d.apr)/100) / 12
        }));

        // Strategy: avalanche (highest APR first) by default
        debts.sort((a,b)=>toNumber(b.apr)-toNumber(a.apr));

        const payoff = debts.map(d=>{
          const min = toNumber(d.minPayment);
          const add = extra > 0 ? extra : 0; // naive: all leftover to first debt
          return {
            ...d,
            suggestedPayment: d === debts[0] ? (min + add) : min
          };
        });

        viewRoot.innerHTML = `
          <div class="grid two">
            <section class="card">
              <div class="sectionTitle">
                <h1>Plan (แบบง่าย)</h1>
                <span class="pill">Avalanche: ดอกสูงก่อน</span>
              </div>

              <div class="hint">
                นี่เป็น “แผนเบื้องต้น” เพื่อช่วยตัดสินใจ ไม่ใช่คำแนะนำการเงินแบบมืออาชีพ<br>
                หลักการ: จ่ายขั้นต่ำทุกก้อน แล้วเอาเงินคงเหลือไปโปะหนี้ดอกสูงสุดก่อน
              </div>

              <div class="divider"></div>

              <div class="row">
                <div class="label">เงินคงเหลือ (ใช้โปะหนี้ได้)</div>
                <div class="amt">${formatTHB(extra)}</div>
              </div>
              <div class="row">
                <div class="label">ถ้าเงินคงเหลือติดลบ</div>
                <div class="amt">ให้ลดรายจ่าย/เพิ่มรายรับก่อน</div>
              </div>

              <div class="divider"></div>
              <div class="hint">
                ถ้าหนี้เป็นบัตรเครดิต และจ่ายแค่ขั้นต่ำ ดอกเบี้ยจะสะสมเร็วมาก — การโปะเพิ่มแม้เล็กน้อยช่วยได้เยอะ
              </div>
            </section>

            <section class="card">
              <div class="sectionTitle">
                <h1>Suggested payments</h1>
                <span class="pill">ต่อเดือน</span>
              </div>
              <div class="list" id="payList"></div>
              <div class="hint" id="payHint"></div>
            </section>
          </div>
        `;

        const payList = $("#payList");
        if (payoff.length === 0){
          $("#payHint").textContent = "ยังไม่มีหนี้ — ไปเพิ่มในแท็บ Debts";
          payList.innerHTML = "";
          return;
        }

        payList.innerHTML = payoff.map((d, idx)=>{
          const badge = idx===0 && extra>0 ? `<span class="pill" style="border-color: rgba(61,220,151,.45); color: var(--good)">โปะเพิ่ม</span>` : "";
          return `
            <div class="item">
              <div class="left">
                <b>${escapeHTML(d.name)}</b>
                <small>APR ${toNumber(d.apr).toFixed(1)}% • ดอกโดยประมาณ/เดือน ${formatTHB(d.estInterest)}</small>
              </div>
              <div class="right" style="flex-direction:column; align-items:flex-end">
                <div style="font-weight:900">${formatTHB(d.suggestedPayment)}</div>
                ${badge}
              </div>
            </div>
          `;
        }).join("");

        $("#payHint").textContent = extra>0
          ? "ระบบเอาเงินคงเหลือทั้งหมดไปโปะหนี้ดอกสูงสุด (ปรับเองได้โดยแก้ “ยอดชำระขั้นต่ำ/ต่อเดือน”)"
          : "เงินคงเหลือไม่พอสำหรับโปะเพิ่ม — โฟกัสทำให้เงินคงเหลือเป็นบวกก่อน";
      }

      // ---------- Simple Charts (Canvas) ----------
      function drawMoneyPieChart(canvas, legendEl){
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;

        // Resize for crispness
        const cssW = canvas.clientWidth;
        const cssH = canvas.clientHeight;
        canvas.width = Math.floor(cssW * dpr);
        canvas.height = Math.floor(cssH * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);

        const t = totals();
        const income = Math.max(0, t.income);
        const fixed = Math.max(0, t.fixedTotal);
        const debtPay = Math.max(0, t.debtMinTotal);
        const left = Math.max(0, income - fixed - debtPay);

        // Avoid divide by zero: if no income, show empty chart
        const total = fixed + debtPay + left;
        const data = [
          { label: "รายจ่ายคงที่", value: fixed, color: "rgba(255,255,255,.32)" },
          { label: "ชำระหนี้ขั้นต่ำ", value: debtPay, color: "rgba(255,209,102,.70)" },
          { label: "เงินคงเหลือ", value: left, color: "rgba(61,220,151,.70)" },
        ];

        // Clear
        ctx.clearRect(0,0,cssW,cssH);

        // Background ring
        const cx = cssW/2, cy = cssH/2;
        const r = Math.min(cssW, cssH)*0.36;
        const rInner = r*0.62;

        // Base
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.arc(cx, cy, rInner, 0, Math.PI*2, true);
        ctx.closePath();
        ctx.fillStyle = "rgba(255,255,255,.06)";
        ctx.fill();

        if (total <= 0){
          // Text
          ctx.fillStyle = "rgba(169,183,214,.8)";
          ctx.font = "700 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.textAlign = "center";
          ctx.fillText("ยังไม่มีข้อมูลรายรับ/รายจ่าย", cx, cy);
          legendEl.innerHTML = "";
          return;
        }

        let start = -Math.PI/2;
        data.forEach(seg=>{
          const frac = seg.value/total;
          const end = start + frac * Math.PI*2;

          ctx.beginPath();
          ctx.moveTo(cx,cy);
          ctx.arc(cx, cy, r, start, end);
          ctx.closePath();
          ctx.fillStyle = seg.color;
          ctx.fill();

          start = end;
        });

        // Hole
        ctx.beginPath();
        ctx.arc(cx, cy, rInner, 0, Math.PI*2);
        ctx.fillStyle = "rgba(11,18,32,1)";
        ctx.fill();

        // Center text
        ctx.fillStyle = "rgba(232,238,252,.95)";
        ctx.font = "900 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.textAlign = "center";
        ctx.fillText("รวมใช้จ่าย", cx, cy - 6);
        ctx.fillStyle = "rgba(169,183,214,.9)";
        ctx.font = "800 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(formatTHB(fixed + debtPay), cx, cy + 16);

        // Legend
        legendEl.innerHTML = data.map(seg=>{
          return `<span><span class="dot" style="background:${seg.color}"></span>${seg.label}: ${formatTHB(seg.value)}</span>`;
        }).join("");
      }

      function drawDebtBarChart(canvas, hintEl){
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;

        const cssW = canvas.clientWidth;
        const cssH = canvas.clientHeight;
        canvas.width = Math.floor(cssW * dpr);
        canvas.height = Math.floor(cssH * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);

        ctx.clearRect(0,0,cssW,cssH);

        const debts = [...state.debts].sort((a,b)=>toNumber(b.balance)-toNumber(a.balance)).slice(0,8);
        if (debts.length === 0){
          ctx.fillStyle = "rgba(169,183,214,.8)";
          ctx.font = "700 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.textAlign = "center";
          ctx.fillText("ยังไม่มีหนี้", cssW/2, cssH/2);
          hintEl.textContent = "เพิ่มหนี้ในแท็บ Debts เพื่อดูกราฟ";
          return;
        }
        hintEl.textContent = debts.length < state.debts.length ? "แสดง 8 รายการยอดหนี้สูงสุด" : "";

        const padding = 18;
        const chartTop = 10;
        const chartBottom = cssH - 24;
        const chartH = chartBottom - chartTop;
        const chartW = cssW - padding*2;

        const maxVal = Math.max(...debts.map(d=>toNumber(d.balance)), 1);
        const barGap = 10;
        const barW = Math.max(18, Math.floor((chartW - barGap*(debts.length-1)) / debts.length));

        // Axis baseline
        ctx.strokeStyle = "rgba(255,255,255,.14)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding, chartBottom);
        ctx.lineTo(padding + chartW, chartBottom);
        ctx.stroke();

        // Bars
        debts.forEach((d,i)=>{
          const v = toNumber(d.balance);
          const h = (v / maxVal) * (chartH - 18);
          const x = padding + i*(barW+barGap);
          const y = chartBottom - h;

          // color by type
          const fill = d.type === "credit" ? "rgba(122,162,255,.72)" : "rgba(255,209,102,.72)";

          // bar
          roundRect(ctx, x, y, barW, h, 10);
          ctx.fillStyle = fill;
          ctx.fill();

          // label (truncate)
          const name = (d.name || "").trim();
          const short = name.length > 10 ? name.slice(0,10) + "…" : name;

          ctx.fillStyle = "rgba(169,183,214,.95)";
          ctx.font = "700 11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.textAlign = "center";
          ctx.fillText(short || "หนี้", x + barW/2, cssH - 8);

          // value on top
          ctx.fillStyle = "rgba(232,238,252,.95)";
          ctx.font = "800 11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.fillText(Math.round(v).toLocaleString("th-TH"), x + barW/2, Math.max(12, y - 6));
        });
      }

      function roundRect(ctx, x, y, w, h, r){
        const rr = Math.min(r, w/2, h/2);
        ctx.beginPath();
        ctx.moveTo(x+rr, y);
        ctx.arcTo(x+w, y, x+w, y+h, rr);
        ctx.arcTo(x+w, y+h, x, y+h, rr);
        ctx.arcTo(x, y+h, x, y, rr);
        ctx.arcTo(x, y, x+w, y, rr);
        ctx.closePath();
      }

      // ---------- Routing (Tabs) ----------
      let currentTab = "dashboard";

      function setTab(tab){
        currentTab = tab;
        $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
        if (tab==="dashboard") renderDashboard();
        else if (tab==="income") renderIncome();
        else if (tab==="debts") renderDebts();
        else renderPlan();
        // After render, update charts on resize
        requestAnimationFrame(()=>refreshChartsIfNeeded());
      }

      function refreshChartsIfNeeded(){
        if (currentTab !== "dashboard") return;
        const pie = $("#pieChart");
        const bar = $("#barChart");
        if (pie) drawMoneyPieChart(pie, $("#pieLegend"));
        if (bar) drawDebtBarChart(bar, $("#barHint"));
      }

      // ---------- Autosave ----------
      let saveTimer = null;
      function autosave(){
        clearTimeout(saveTimer);
        saveTimer = setTimeout(()=>{
          store.save(state);
          setLastSaved();
        }, 120);
      }

      // ---------- Escape helpers ----------
      function escapeHTML(s){
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }
      function escapeHTMLAttr(s){ return escapeHTML(s).replaceAll("\n"," "); }
      function cssEscape(s){
        // minimal escape for attribute query usage
        return String(s).replaceAll('"','\\"');
      }

      // ---------- Init ----------
      setMonthLabel();
      setLastSaved();

      $$(".tab").forEach(el=>{
        el.addEventListener("click", ()=>setTab(el.dataset.tab));
      });

      $("#resetBtn").addEventListener("click", ()=>{
        const ok = confirm("ล้างข้อมูลทั้งหมดในเครื่องนี้? (ย้อนกลับไม่ได้)");
        if (!ok) return;
        store.reset();
        state = store.load();
        setMonthLabel();
        setLastSaved();
        setTab("dashboard");
        showToast("ล้างข้อมูลแล้ว");
      });

      // redraw charts on resize
      window.addEventListener("resize", ()=>{
        refreshChartsIfNeeded();
      });

      // initial render
      setTab("dashboard");
    })();
  </script>
</body>
</html>