<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Can I Afford This? | ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏ß‡πÑ‡∏´‡∏°</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111826;
      --panel2:#0f1622;
      --text:#e8eef7;
      --muted:#a8b3c7;
      --line:#223049;
      --good:#1ee37a;
      --ok:#ffd166;
      --bad:#ff4d6d;
      --no:#ff2d55;
      --chip:#162338;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, #13213a 0%, var(--bg) 55%) fixed;
      color:var(--text);
      font: 15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header{
      padding:18px 16px 10px;
      max-width:1100px; margin:0 auto;
      display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap;
    }
    h1{margin:0; font-size:18px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:12.5px}
    .topActions{display:flex; gap:8px; flex-wrap:wrap}
    button{
      appearance:none; border:1px solid var(--line); background:linear-gradient(180deg, #162338, #101a2a);
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }
    button:active{transform:translateY(1px)}
    button.secondary{background:transparent}
    main{
      max-width:1100px; margin:0 auto; padding:10px 16px 28px;
      display:grid; gap:14px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(34,48,73,.7);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border-bottom:1px solid rgba(34,48,73,.55);
      background: linear-gradient(180deg, rgba(22,35,56,.65), rgba(17,24,38,.15));
    }
    .cardHead h2{margin:0; font-size:14px}
    .hint{color:var(--muted); font-size:12px}
    .cardBody{padding:14px}
    .grid2{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    @media (max-width: 520px){ .grid2{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    .field{
      background: rgba(15,22,34,.85);
      border:1px solid rgba(34,48,73,.85);
      border-radius:14px;
      padding:10px 10px;
      display:flex; gap:10px; align-items:center;
    }
    .field input, .field select{
      width:100%;
      background: transparent;
      border:0; outline:none;
      color:var(--text);
      font-size:14px;
    }
    .prefix{
      color:var(--muted);
      font-size:12px;
      padding:6px 8px;
      background: rgba(22,35,56,.75);
      border:1px solid rgba(34,48,73,.6);
      border-radius: 999px;
      white-space:nowrap;
    }
    .row{display:grid; gap:10px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      border:1px solid rgba(34,48,73,.7);
      background: rgba(22,35,56,.35);
      padding:9px 10px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-size:12.5px;
      color:var(--muted);
    }
    .tab.active{color:var(--text); background: rgba(22,35,56,.8)}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      background: rgba(22,35,56,.7);
      border:1px solid rgba(34,48,73,.6);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .chip.active{color:var(--text); border-color: rgba(255,255,255,.18)}
    .resultTop{
      display:flex; align-items:stretch; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .badge{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      min-width: 220px;
    }
    .badge .big{font-size:18px; font-weight:700; letter-spacing:.3px}
    .badge .small{color:var(--muted); font-size:12px; margin-top:3px}
    .badge.good{border-color: rgba(30,227,122,.35); box-shadow: 0 0 0 1px rgba(30,227,122,.1) inset}
    .badge.ok{border-color: rgba(255,209,102,.35)}
    .badge.bad{border-color: rgba(255,77,109,.35)}
    .badge.no{border-color: rgba(255,45,85,.38)}
    .kpis{
      flex:1;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      min-width: 280px;
    }
    @media (max-width: 700px){ .kpis{grid-template-columns:1fr 1fr} }
    .kpi{
      background: rgba(15,22,34,.8);
      border:1px solid rgba(34,48,73,.7);
      border-radius:14px;
      padding:10px 10px;
    }
    .kpi .t{color:var(--muted); font-size:12px}
    .kpi .v{font-size:16px; font-weight:700; margin-top:4px}
    .kpi .s{color:var(--muted); font-size:12px; margin-top:4px}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(34,48,73,.65);
      background: rgba(15,22,34,.75);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(34,48,73,.5);
      font-size:13px;
    }
    th{color:var(--muted); text-align:left; font-weight:600; background: rgba(22,35,56,.35)}
    tr:last-child td{border-bottom:0}
    .right{ text-align:right }
    .muted{color:var(--muted)}
    .warn{color:var(--ok)}
    .danger{color:var(--bad)}
    .goodText{color:var(--good)}
    .canvasWrap{
      background: rgba(15,22,34,.78);
      border:1px solid rgba(34,48,73,.7);
      border-radius:14px;
      padding:10px;
    }
    canvas{width:100%; height:210px; display:block}
    .smallNote{color:var(--muted); font-size:12px; margin-top:8px}
    .twoCols{
      display:grid; gap:12px; grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 850px){ .twoCols{grid-template-columns:1fr} }
    .divider{height:1px; background: rgba(34,48,73,.55); margin:10px 0}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Can I Afford This? <span class="muted">| ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏ß‡πÑ‡∏´‡∏°</span></h1>
      <div class="sub">Brutal cashflow + emergency fund + stress test. <span class="muted">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö ‚Äú‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‚Äù ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà % ‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></div>
    </div>
    <div class="topActions">
      <button id="btnSave">Save | ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button id="btnLoad" class="secondary">Load | ‡πÇ‡∏´‡∏•‡∏î</button>
      <button id="btnReset" class="secondary">Reset | ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>
  </header>

  <main>
    <!-- LEFT: INPUTS -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>Inputs | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
          <div class="hint">THB amounts are monthly unless stated. <span class="muted">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‚Äù ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</span></div>
        </div>
        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="item">Item | ‡∏Ç‡∏≠‡∏á</div>
          <div class="tab" data-tab="income">Income | ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
          <div class="tab" data-tab="oblig">Obligations | ‡∏†‡∏≤‡∏£‡∏∞</div>
          <div class="tab" data-tab="behavior">Behavior | ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</div>
        </div>
      </div>

      <div class="cardBody">
        <!-- ITEM -->
        <div class="tabPanel" id="tab-item">
          <div class="grid2">
            <div class="row">
              <label>Item name | ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á (optional)</label>
              <div class="field">
                <span class="prefix">üßæ</span>
                <input id="itemName" placeholder="iPhone / Trip / Bike / etc." />
              </div>
            </div>

            <div class="row">
              <label>Item price (one-time) | ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</label>
              <div class="field">
                <span class="prefix">THB</span>
                <input id="itemPrice" type="number" min="0" step="100" value="25000" />
              </div>
            </div>

            <div class="row">
              <label>Extra one-time costs | ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</label>
              <div class="field">
                <span class="prefix">THB</span>
                <input id="oneTimeExtra" type="number" min="0" step="100" value="0" />
              </div>
            </div>

            <div class="row">
              <label>Recurring cost / month | ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <div class="field">
                <span class="prefix">THB</span>
                <input id="recurringMonthly" type="number" min="0" step="50" value="0" />
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div class="row">
              <label>Payment method | ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢</label>
              <div class="field">
                <span class="prefix">üí≥</span>
                <select id="payMethod">
                  <option value="cash">Cash | ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                  <option value="cc_full">Credit card (pay full) | ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°</option>
                  <option value="inst0">Installment 0% | ‡∏ú‡πà‡∏≠‡∏ô 0%</option>
                  <option value="inst_int">Installment w/ interest | ‡∏ú‡πà‡∏≠‡∏ô‡∏°‡∏µ‡∏î‡∏≠‡∏Å</option>
                </select>
              </div>
            </div>

            <div class="row">
              <label>Down payment (one-time) | ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</label>
              <div class="field">
                <span class="prefix">THB</span>
                <input id="downPayment" type="number" min="0" step="100" value="0" />
              </div>
            </div>

            <div class="row">
              <label>Months (for installment) | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ú‡πà‡∏≠‡∏ô)</label>
              <div class="field">
                <span class="prefix">mo</span>
                <input id="instMonths" type="number" min="1" step="1" value="10" />
              </div>
            </div>

            <div class="row">
              <label>APR % (if interest) | ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ % (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <div class="field">
                <span class="prefix">%</span>
                <input id="apr" type="number" min="0" step="0.1" value="18" />
              </div>
            </div>
          </div>

          <div class="smallNote">
            Logic | ‡∏ï‡∏£‡∏£‡∏Å‡∏∞: Installment uses standard amortization if interest; 0% = principal/month.
          </div>
        </div>

        <!-- INCOME -->
        <div class="tabPanel" id="tab-income" style="display:none">
          <div class="grid2">
            <div class="row">
              <label>Monthly net income | ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <div class="field">
                <span class="prefix">THB</span>
                <input id="incomeNet" type="number" min="0" step="100" value="45000" />
              </div>
            </div>

            <div class="row">
              <label>Extra income avg / month | ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <div class="field">
                <span class="prefix">THB</span>
                <input id="incomeExtra" type="number" min="0" step="100" value="0" />
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div class="row">
              <label>Current savings balance | ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
              <div class="field">
                <span class="prefix">THB</span>
                <input id="savingsNow" type="number" min="0" step="100" value="60000" />
              </div>
            </div>

            <div class="row">
              <label>Emergency fund target (months) | ‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
              <div class="field">
                <span class="prefix">mo</span>
                <input id="emTarget" type="number" min="0" step="0.5" value="3" />
              </div>
            </div>
          </div>
        </div>

        <!-- OBLIGATIONS -->
        <div class="tabPanel" id="tab-oblig" style="display:none">
          <div class="grid2">
            <div class="row">
              <label>Rent / mortgage | ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</label>
              <div class="field"><span class="prefix">THB</span><input id="rent" type="number" min="0" step="100" value="12000" /></div>
            </div>
            <div class="row">
              <label>Debt minimum payments | ‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
              <div class="field"><span class="prefix">THB</span><input id="debtMin" type="number" min="0" step="100" value="5000" /></div>
            </div>

            <div class="row">
              <label>Family support | ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ö‡πâ‡∏≤‡∏ô</label>
              <div class="field"><span class="prefix">THB</span><input id="family" type="number" min="0" step="100" value="0" /></div>
            </div>
            <div class="row">
              <label>Utilities + phone + internet | ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡πÑ‡∏ü+‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå+‡πÄ‡∏ô‡πá‡∏ï</label>
              <div class="field"><span class="prefix">THB</span><input id="utilities" type="number" min="0" step="50" value="2500" /></div>
            </div>

            <div class="row">
              <label>Transport baseline | ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</label>
              <div class="field"><span class="prefix">THB</span><input id="transport" type="number" min="0" step="100" value="3500" /></div>
            </div>
            <div class="row">
              <label>Insurance (optional) | ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <div class="field"><span class="prefix">THB</span><input id="insurance" type="number" min="0" step="100" value="0" /></div>
            </div>
          </div>
        </div>

        <!-- BEHAVIOR -->
        <div class="tabPanel" id="tab-behavior" style="display:none">
          <div class="row">
            <label>Variable spend preset | ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡πá‡∏ß)</label>
            <div class="chips" id="spendPreset">
              <div class="chip" data-v="low">Low | ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î</div>
              <div class="chip active" data-v="normal">Normal | ‡∏õ‡∏Å‡∏ï‡∏¥</div>
              <div class="chip" data-v="high">High | ‡πÉ‡∏ä‡πâ‡πÄ‡∏¢‡∏≠‡∏∞</div>
              <div class="chip" data-v="custom">Custom | ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</div>
            </div>
          </div>

          <div class="grid2" style="margin-top:10px">
            <div class="row">
              <label>Variable spend / month | ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <div class="field">
                <span class="prefix">THB</span>
                <input id="variableSpend" type="number" min="0" step="100" value="14000" />
              </div>
              <div class="smallNote">Food + coffee + entertainment + shopping. <span class="muted">‡∏£‡∏ß‡∏°‡∏Å‡∏¥‡∏ô/‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß/‡∏ä‡πâ‡∏≠‡∏õ</span></div>
            </div>

            <div class="row">
              <label>Invest return assumption | ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô</label>
              <div class="field">
                <span class="prefix">%</span>
                <input id="investRate" type="number" min="0" step="0.5" value="6" />
              </div>
              <div class="smallNote">Used for opportunity cost. <span class="muted">‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‚Äú‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‚Äù</span></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <label>Stress test | ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏¢‡πà‡πÜ</label>
            <div class="chips" id="stressChips">
              <div class="chip active" data-s="none">None | ‡πÑ‡∏°‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
              <div class="chip" data-s="income10">Income -10% | ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ -10%</div>
              <div class="chip" data-s="shock10">Shock 10,000 | ‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 10,000</div>
              <div class="chip" data-s="shock30">Shock 30,000 | ‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 30,000</div>
              <div class="chip" data-s="aprPlus3">APR +3% | ‡∏î‡∏≠‡∏Å +3%</div>
            </div>
            <div class="smallNote">Stress affects the verdict and ‚Äúworst-month‚Äù balance. <span class="muted">‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏î‡∏π‡∏ß‡πà‡∏≤ ‚Äú‡∏û‡∏±‡∏á‡πÑ‡∏´‡∏°‚Äù ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: RESULTS -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>Results | ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2>
          <div class="hint">Updates instantly. <span class="muted">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span></div>
        </div>
        <div class="hint" id="lastUpdated"></div>
      </div>

      <div class="cardBody">
        <div class="resultTop">
          <div class="badge" id="verdictBadge">
            <div class="big" id="verdictText">‚Äî</div>
            <div class="small" id="verdictReason">‚Äî</div>
          </div>
          <div class="kpis">
            <div class="kpi">
              <div class="t">Leftover / month | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
              <div class="v" id="kpiLeftover">‚Äî</div>
              <div class="s" id="kpiLeftoverNote">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="t">Emergency months | ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</div>
              <div class="v" id="kpiEmMonths">‚Äî</div>
              <div class="s" id="kpiEmNote">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="t">Installment share | ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡πà‡∏≠‡∏ô</div>
              <div class="v" id="kpiInstShare">‚Äî</div>
              <div class="s" id="kpiDTI">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoCols">
          <div>
            <table>
              <thead>
                <tr>
                  <th>Cashflow | ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô</th>
                  <th class="right">THB / month</th>
                </tr>
              </thead>
              <tbody id="cashflowTable"></tbody>
            </table>

            <div class="smallNote" id="daysOfWorkText">‚Äî</div>
          </div>

          <div>
            <div class="canvasWrap">
              <div class="hint">Opportunity cost (3 years) | ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÑ‡∏õ (3 ‡∏õ‡∏µ)</div>
              <canvas id="oppCanvas" width="900" height="420"></canvas>
              <div class="smallNote" id="oppNote">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <table>
          <thead>
            <tr>
              <th>Stress test summary | ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
              <th class="right">Result</th>
            </tr>
          </thead>
          <tbody id="stressTable"></tbody>
        </table>

        <div class="divider"></div>

        <table>
          <thead>
            <tr>
              <th>Actions | ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ ‚Äú‡πÑ‡∏´‡∏ß‚Äù</th>
              <th class="right">Suggestion</th>
            </tr>
          </thead>
          <tbody id="actionsTable"></tbody>
        </table>

        <div class="smallNote">
          Notes | ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: This tool is directional (not financial advice). <span class="muted">‡πÉ‡∏ä‡πâ‡∏î‡∏π ‚Äú‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏´‡∏ß‚Äù ‡πÅ‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</span>
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  const ids = [
    "itemName","itemPrice","oneTimeExtra","recurringMonthly","payMethod","downPayment","instMonths","apr",
    "incomeNet","incomeExtra","savingsNow","emTarget",
    "rent","debtMin","family","utilities","transport","insurance",
    "variableSpend","investRate"
  ];

  let spendPreset = "normal";
  let stressMode = "none";

  const fmt = new Intl.NumberFormat("th-TH", { maximumFractionDigits: 0 });
  const fmt2 = new Intl.NumberFormat("th-TH", { maximumFractionDigits: 2 });

  function nowStamp(){
    const d = new Date();
    return d.toLocaleString("en-GB", { hour12:false });
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function getState(){
    const s = {};
    ids.forEach(k => s[k] = ( $(k).type === "number" ? Number($(k).value||0) : $(k).value ));
    s.spendPreset = spendPreset;
    s.stressMode = stressMode;
    return s;
  }

  function setState(s){
    ids.forEach(k => {
      if(!(k in s)) return;
      $(k).value = s[k];
    });
    spendPreset = s.spendPreset || "normal";
    stressMode = s.stressMode || "none";
    syncPresetUI();
    syncStressUI();
    recalc();
  }

  function save(){
    localStorage.setItem("canIAffordTH_v1", JSON.stringify(getState()));
  }
  function load(){
    const raw = localStorage.getItem("canIAffordTH_v1");
    if(!raw) return;
    setState(JSON.parse(raw));
  }
  function reset(){
    localStorage.removeItem("canIAffordTH_v1");
    location.reload();
  }

  function amortizedMonthlyPayment(principal, aprPct, months){
    // Standard amortization: P * r / (1 - (1+r)^-n)
    if(months <= 0) return 0;
    const r = (aprPct/100)/12;
    if(r <= 0) return principal / months;
    const denom = 1 - Math.pow(1+r, -months);
    return principal * (r/denom);
  }

  function paymentMonthly(s){
    const priceTotal = Math.max(0, s.itemPrice) + Math.max(0, s.oneTimeExtra);
    const dp = clamp(Math.max(0, s.downPayment), 0, priceTotal);
    const financed = Math.max(0, priceTotal - dp);

    const m = Math.max(1, Math.round(s.instMonths || 1));
    const method = s.payMethod;

    let monthly = 0;
    let totalPaid = priceTotal;

    if(method === "cash"){
      monthly = 0;
      totalPaid = priceTotal; // paid upfront (we treat as hit to savings)
    } else if(method === "cc_full"){
      monthly = 0; // assume paid from cashflow this month? we treat as hit to savings for conservative view
      totalPaid = priceTotal;
    } else if(method === "inst0"){
      monthly = financed / m;
      totalPaid = dp + monthly * m;
    } else if(method === "inst_int"){
      const apr = Math.max(0, s.apr);
      monthly = amortizedMonthlyPayment(financed, apr, m);
      totalPaid = dp + monthly * m;
    }
    return { priceTotal, dp, financed, monthly, months:m, totalPaid };
  }

  function essentialsMonthly(s){
    return (
      Math.max(0,s.rent) +
      Math.max(0,s.debtMin) +
      Math.max(0,s.family) +
      Math.max(0,s.utilities) +
      Math.max(0,s.transport) +
      Math.max(0,s.insurance)
    );
  }

  function applyPreset(s){
    // Sets variable spend based on income net+extra if preset not custom.
    const income = Math.max(0,s.incomeNet) + Math.max(0,s.incomeExtra);
    const ess = essentialsMonthly(s);
    const disposable = Math.max(0, income - ess);

    if(spendPreset === "custom") return;

    // Heuristic: percent of disposable (not income) ‚Äì more realistic.
    let pct = 0.55; // normal
    if(spendPreset === "low") pct = 0.40;
    if(spendPreset === "high") pct = 0.75;

    const v = Math.round(disposable * pct / 100) * 100;
    // keep at least a small number if disposable is tiny
    s.variableSpend = clamp(v, 0, 999999999);
    $("variableSpend").value = s.variableSpend;
  }

  function stressAdjust(s, pay){
    // Return adjusted: income, shockOneTime, aprAdj
    let incomeAdj = (Math.max(0,s.incomeNet) + Math.max(0,s.incomeExtra));
    let shock = 0;
    let aprAdj = Math.max(0,s.apr);

    if(stressMode === "income10"){
      incomeAdj *= 0.90;
    } else if(stressMode === "shock10"){
      shock = 10000;
    } else if(stressMode === "shock30"){
      shock = 30000;
    } else if(stressMode === "aprPlus3"){
      aprAdj = aprAdj + 3;
    }

    // if APR changes, recompute monthly
    let pay2 = {...pay};
    if(stressMode === "aprPlus3" && s.payMethod === "inst_int"){
      const financed = pay.financed;
      pay2.monthly = amortizedMonthlyPayment(financed, aprAdj, pay.months);
      pay2.totalPaid = pay.dp + pay2.monthly * pay.months;
    }
    return { incomeAdj, shock, aprAdj, payAdj: pay2 };
  }

  function verdict(s, metrics){
    // Scoring logic (brutal but stable)
    // Key metrics:
    // - leftover
    // - emergency months after purchase
    // - installment share
    // - obligations share
    // - worstMonthBalance
    let score = 0;

    // leftover score
    if(metrics.leftover >= 0.25 * metrics.income) score += 2;
    else if(metrics.leftover >= 0.10 * metrics.income) score += 1;
    else if(metrics.leftover >= 0) score += 0;
    else score -= 3;

    // emergency fund
    if(metrics.emMonthsAfter >= s.emTarget) score += 2;
    else if(metrics.emMonthsAfter >= Math.max(1, s.emTarget*0.6)) score += 0;
    else score -= 2;

    // installment share
    if(metrics.installShare <= 0.10) score += 2;
    else if(metrics.installShare <= 0.15) score += 1;
    else if(metrics.installShare <= 0.25) score -= 1;
    else score -= 3;

    // obligations share
    if(metrics.obligShare <= 0.55) score += 1;
    else if(metrics.obligShare <= 0.70) score += 0;
    else score -= 2;

    // worst month
    if(metrics.worstMonthBalance >= 0) score += 1;
    else score -= 2;

    // Determine label
    if(score >= 4) return { level:"SAFE | ‡πÑ‡∏´‡∏ß", cls:"good", reason:"Healthy buffer + emergency fund ok. | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏≠ + ‡∏Å‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà" };
    if(score >= 1) return { level:"OK but tight | ‡πÑ‡∏´‡∏ß‡πÅ‡∏ï‡πà‡∏ï‡∏∂‡∏á", cls:"ok", reason:"You can, but any bad month hurts. | ‡∏ó‡∏≥‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏¢‡πà‡πÜ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á" };
    if(score >= -2) return { level:"RISKY | ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á", cls:"bad", reason:"Buffer too thin. Consider cheaper / delay. | ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏ö‡∏≤‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô" };
    return { level:"NO | ‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß", cls:"no", reason:"This will break your cashflow or emergency fund. | ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô/‡∏Å‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏û‡∏±‡∏á" };
  }

  function drawOpp(canvas, a, b, note){
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    // background
    ctx.fillStyle = "rgba(255,255,255,0.02)";
    ctx.fillRect(0,0,W,H);

    // axes
    const pad = 48;
    const x0 = pad, y0 = H - pad;
    const x1 = W - pad, y1 = pad;

    ctx.strokeStyle = "rgba(168,179,199,0.25)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x0, y0); ctx.lineTo(x1, y0);
    ctx.moveTo(x0, y0); ctx.lineTo(x0, y1);
    ctx.stroke();

    const maxV = Math.max(a.max, b.max, 1);
    const steps = 4;

    // y grid & labels
    ctx.fillStyle = "rgba(168,179,199,0.75)";
    ctx.font = "12px system-ui";
    for(let i=0;i<=steps;i++){
      const t = i/steps;
      const y = y0 - t*(y0-y1);
      ctx.strokeStyle = "rgba(168,179,199,0.12)";
      ctx.beginPath(); ctx.moveTo(x0, y); ctx.lineTo(x1, y); ctx.stroke();
      const val = Math.round(t*maxV);
      ctx.fillText(fmt.format(val), 8, y+4);
    }

    // plot function
    function plot(series, alpha){
      ctx.strokeStyle = alpha;
      ctx.lineWidth = 2;
      ctx.beginPath();
      series.forEach((v, i)=>{
        const x = x0 + (i/(series.length-1))*(x1-x0);
        const y = y0 - (v/maxV)*(y0-y1);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    // series
    plot(a.series, "rgba(30,227,122,0.85)");  // invest
    plot(b.series, "rgba(255,209,102,0.85)"); // save

    // legend
    ctx.fillStyle = "rgba(232,238,247,0.9)";
    ctx.fillText("Invest | ‡∏•‡∏á‡∏ó‡∏∏‡∏ô", x0, y1-14);
    ctx.fillStyle = "rgba(30,227,122,0.85)";
    ctx.fillRect(x0+92, y1-24, 18, 6);

    ctx.fillStyle = "rgba(232,238,247,0.9)";
    ctx.fillText("Save (no return) | ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏â‡∏¢‡πÜ", x0+140, y1-14);
    ctx.fillStyle = "rgba(255,209,102,0.85)";
    ctx.fillRect(x0+330, y1-24, 18, 6);

    // x labels (months)
    ctx.fillStyle = "rgba(168,179,199,0.75)";
    for(let m=0;m<=36;m+=6){
      const x = x0 + (m/36)*(x1-x0);
      ctx.strokeStyle = "rgba(168,179,199,0.12)";
      ctx.beginPath(); ctx.moveTo(x, y0); ctx.lineTo(x, y0+6); ctx.stroke();
      ctx.fillText(String(m), x-6, y0+22);
    }
    ctx.fillText("months | ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", x1-90, y0+22);

    // note
    $("oppNote").textContent = note;
  }

  function recalc(){
    const s = getState();
    applyPreset(s);

    const pay = paymentMonthly(s);
    const essentials = essentialsMonthly(s);

    // stress adjusted
    const st = stressAdjust(s, pay);
    const income = st.incomeAdj;
    const payAdj = st.payAdj;

    // monthly item cost:
    // - installment: monthly payment
    // - cash / cc_full: treat as 0 monthly, but hit savings upfront
    const monthlyItem = (s.payMethod === "inst0" || s.payMethod === "inst_int") ? payAdj.monthly : 0;

    const variable = Math.max(0, s.variableSpend);
    const recurring = Math.max(0, s.recurringMonthly);

    const leftover = income - essentials - variable - monthlyItem - recurring;
    const obligShare = (essentials + variable + recurring + monthlyItem) / Math.max(1, income);

    // Savings impact (upfront hit)
    const upfront = (s.payMethod === "cash" || s.payMethod === "cc_full") ? pay.priceTotal : pay.dp;
    const savingsAfter = Math.max(0, Math.max(0,s.savingsNow) - upfront - st.shock);

    // Emergency months (essential spend: essentials + variable? Use essentials+baseline variable at minimum? We'll use essentials + (0.6*variable) to reflect reality)
    const essentialSpend = Math.max(1, essentials + 0.60*variable + recurring);
    const emMonthsNow = Math.max(0, Math.max(0,s.savingsNow) / essentialSpend);
    const emMonthsAfter = Math.max(0, savingsAfter / essentialSpend);

    // Installment share (if installment)
    const installShare = monthlyItem / Math.max(1, income);
    const dti = (Math.max(0,s.debtMin) + monthlyItem) / Math.max(1, income);

    // worst month balance: add shock (already applied to savings, but also show if cashflow negative with lower income / higher payment)
    const worstMonthBalance = leftover; // under selected stress mode

    // days of real disposable income cost
    const disposable = Math.max(1, income - essentials - variable - recurring);
    const daysCost = (pay.priceTotal) / (disposable / 30);

    // opportunity cost (3 years)
    const rate = Math.max(0, s.investRate)/100;
    const months = 36;
    const lump = pay.priceTotal;
    const investSeries = [];
    const saveSeries = [];
    for(let m=0; m<=months; m++){
      const fv = lump * Math.pow(1 + rate/12, m);
      investSeries.push(fv);
      saveSeries.push(lump); // keep cash, no return
    }
    const oppNote = `If invested at ${fmt2.format(s.investRate)}%/yr: ~${fmt.format(investSeries[months])} THB in 3 years. | ‡∏ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô ${fmt2.format(s.investRate)}% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ: ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${fmt.format(investSeries[months])} ‡πÉ‡∏ô 3 ‡∏õ‡∏µ`;

    // verdict
    const metrics = { leftover, income, emMonthsAfter, installShare, obligShare, worstMonthBalance };
    const v = verdict(s, metrics);

    // UI updates
    $("lastUpdated").textContent = nowStamp();

    // badge
    const badge = $("verdictBadge");
    badge.className = "badge " + v.cls;
    $("verdictText").textContent = v.level;
    $("verdictReason").textContent = v.reason;

    // KPIs
    $("kpiLeftover").textContent = (leftover>=0 ? `${fmt.format(leftover)} THB` : `-${fmt.format(Math.abs(leftover))} THB`);
    $("kpiLeftover").className = "v " + (leftover>=0 ? "goodText" : "danger");
    $("kpiLeftoverNote").textContent = `Savings rate: ${fmt2.format(Math.max(0,leftover)/Math.max(1,income)*100)}% | ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏≠‡∏≠‡∏°`;

    $("kpiEmMonths").textContent = `${fmt2.format(emMonthsAfter)} mo`;
    $("kpiEmMonths").className = "v " + (emMonthsAfter>=s.emTarget ? "goodText" : (emMonthsAfter>=Math.max(1,s.emTarget*0.6) ? "warn" : "danger"));
    $("kpiEmNote").textContent = `Target: ${fmt2.format(s.emTarget)} mo | ‡πÄ‡∏õ‡πâ‡∏≤`;

    $("kpiInstShare").textContent = `${fmt2.format(installShare*100)}%`;
    $("kpiInstShare").className = "v " + (installShare<=0.10 ? "goodText" : (installShare<=0.15 ? "warn" : "danger"));
    $("kpiDTI").textContent = `DTI (debt+new): ${fmt2.format(dti*100)}%`;

    // cashflow table
    const rows = [
      ["Income | ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ", income],
      ["Essentials (fixed) | ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô", -essentials],
      ["Variable spend | ‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô", -variable],
      ["New item monthly | ‡∏ú‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", -monthlyItem],
      ["Recurring item cost | ‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á", -recurring],
      ["Leftover | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠", leftover],
    ];
    $("cashflowTable").innerHTML = rows.map(([k, val])=>{
      const cls = (k.includes("Leftover") ? (val>=0 ? "goodText" : "danger") : "muted");
      const sign = val>=0 ? "" : "-";
      const n = Math.abs(val);
      return `<tr>
        <td>${k}</td>
        <td class="right ${cls}">${sign}${fmt.format(n)}</td>
      </tr>`;
    }).join("");

    // days of work
    $("daysOfWorkText").textContent = `Time cost: ~${fmt2.format(daysCost)} days of REAL disposable income. | ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πá‡∏ô ~${fmt2.format(daysCost)} ‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á ‚Äú‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á‚Äù`;

    // stress table
    const stressRows = [
      ["Stress mode | ‡πÇ‡∏´‡∏°‡∏î", stressMode],
      ["Upfront hit to savings | ‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ", upfront + (st.shock||0)],
      ["Savings after purchase | ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ã‡∏∑‡πâ‡∏≠", savingsAfter],
      ["Emergency months now | ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô", emMonthsNow],
      ["Emergency months after | ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏á", emMonthsAfter],
      ["Worst-month leftover | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏¢‡πà‡∏™‡∏∏‡∏î", worstMonthBalance],
    ];
    $("stressTable").innerHTML = stressRows.map(([k,val])=>{
      let right = "";
      if(typeof val === "number"){
        if(k.includes("months")) right = fmt2.format(val) + " mo";
        else right = fmt.format(val);
      } else {
        right = String(val);
      }
      let cls = "muted";
      if(k.includes("Worst") || k.includes("after")){
        if(typeof val === "number"){
          if(k.includes("Worst")) cls = (val>=0 ? "goodText" : "danger");
          if(k.includes("after") && k.includes("months")) cls = (val>=s.emTarget ? "goodText" : (val>=Math.max(1,s.emTarget*0.6) ? "warn" : "danger"));
        }
      }
      return `<tr><td>${k}</td><td class="right ${cls}">${right}</td></tr>`;
    }).join("");

    // actions table (make it actionable)
    const actions = [];

    // Safe price estimation (binary search on priceTotal) to reach "OK but tight" at least, under current stress
    function canAtPrice(p){
      const s2 = {...s, itemPrice: p - s.oneTimeExtra};
      const pay2 = paymentMonthly(s2);
      const st2 = stressAdjust(s2, pay2);
      const income2 = st2.incomeAdj;
      const essentials2 = essentialsMonthly(s2);
      const monthlyItem2 = (s2.payMethod === "inst0" || s2.payMethod === "inst_int") ? st2.payAdj.monthly : 0;
      const variable2 = Math.max(0, s2.variableSpend);
      const recurring2 = Math.max(0, s2.recurringMonthly);
      const leftover2 = income2 - essentials2 - variable2 - monthlyItem2 - recurring2;
      const upfront2 = (s2.payMethod === "cash" || s2.payMethod === "cc_full") ? pay2.priceTotal : pay2.dp;
      const savingsAfter2 = Math.max(0, Math.max(0,s2.savingsNow) - upfront2 - (st2.shock||0));
      const essentialSpend2 = Math.max(1, essentials2 + 0.60*variable2 + recurring2);
      const emAfter2 = Math.max(0, savingsAfter2/essentialSpend2);
      const installShare2 = monthlyItem2 / Math.max(1, income2);
      const obligShare2 = (essentials2 + variable2 + recurring2 + monthlyItem2)/Math.max(1,income2);
      const vv = verdict(s2, {leftover:leftover2, income:income2, emMonthsAfter:emAfter2, installShare:installShare2, obligShare:obligShare2, worstMonthBalance:leftover2});
      return (vv.cls === "good" || vv.cls === "ok");
    }

    // compute safe price by searching from 0..current
    const currentTotal = pay.priceTotal;
    let lo = 0, hi = Math.max(0, currentTotal), ans = hi;
    for(let i=0;i<22;i++){
      const mid = (lo+hi)/2;
      if(canAtPrice(mid)){
        ans = mid; lo = mid;
      } else {
        hi = mid;
      }
    }
    const safePrice = Math.round(ans/100)*100;

    actions.push(["Safe max price | ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á ‚Äú‡∏û‡∏≠‡πÑ‡∏´‡∏ß‚Äù", `${fmt.format(safePrice)} THB (under current stress mode)`]);

    // suggest saving plan if risky
    const gap = Math.max(0, currentTotal - safePrice);
    if(gap > 0){
      const savePerMonth = clamp(Math.round(gap/6/100)*100, 500, 999999999);
      actions.push(["Save then buy | ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏ã‡∏∑‡πâ‡∏≠",
        `Reduce price by ${fmt.format(gap)} THB or save ~${fmt.format(savePerMonth)} THB/month for 6 months.`]);
    }

    // installment suggestion
    if(s.payMethod === "cash" || s.payMethod === "cc_full"){
      actions.push(["Option | ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å",
        `If you must buy: consider 0% installment to protect emergency fund (but keep leftover ‚â• 0). | ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ‡∏ú‡πà‡∏≠‡∏ô 0% ‡∏à‡∏∞‡∏Å‡∏±‡∏ô‡∏Å‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÑ‡∏î‡πâ`]);
    } else {
      // extend months suggestion
      const m = pay.months;
      const m2 = clamp(m + 6, 1, 60);
      if(s.payMethod === "inst0"){
        const monthly2 = pay.financed / m2;
        actions.push(["Lower monthly | ‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î",
          `Extend to ${m2} months ‚Üí ~${fmt.format(monthly2)} THB/month (0%).`]);
      } else if(s.payMethod === "inst_int"){
        const monthly2 = amortizedMonthlyPayment(pay.financed, Math.max(0,s.apr), m2);
        actions.push(["Lower monthly | ‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î",
          `Extend to ${m2} months ‚Üí ~${fmt.format(monthly2)} THB/month (interest).`]);
      }
    }

    // variable spend cut suggestion
    if(leftover < 0 || installShare > 0.15){
      const cut = clamp(Math.round((Math.abs(Math.min(0,leftover)) + income*0.05)/100)*100, 300, 20000);
      actions.push(["Cut variable spend | ‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô",
        `Try cutting ~${fmt.format(cut)} THB/month (coffee/food/entertainment) until stable.`]);
    }

    // emergency fund restore
    if(emMonthsAfter < s.emTarget){
      const need = Math.max(0, s.emTarget*essentialSpend - savingsAfter);
      actions.push(["Restore emergency fund | ‡πÄ‡∏ï‡∏¥‡∏°‡∏Å‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô",
        `Need ~${fmt.format(need)} THB to reach target (${fmt2.format(s.emTarget)} mo).`]);
    }

    $("actionsTable").innerHTML = actions.map(([k,v])=>`<tr><td>${k}</td><td class="right">${v}</td></tr>`).join("");

    // opportunity chart
    drawOpp($("oppCanvas"),
      { series: investSeries, max: investSeries[months] },
      { series: saveSeries, max: investSeries[months] },
      oppNote
    );
  }

  // Tabs
  function showTab(name){
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    document.querySelectorAll(".tabPanel").forEach(p => p.style.display = "none");
    $("tab-"+name).style.display = "block";
  }
  $("tabs").addEventListener("click", (e)=>{
    const t = e.target.closest(".tab");
    if(!t) return;
    showTab(t.dataset.tab);
  });

  // Spend preset UI
  function syncPresetUI(){
    document.querySelectorAll("#spendPreset .chip").forEach(c=>{
      c.classList.toggle("active", c.dataset.v === spendPreset);
    });
    const custom = (spendPreset === "custom");
    $("variableSpend").disabled = !custom;
    $("variableSpend").style.opacity = custom ? "1" : ".85";
  }
  $("spendPreset").addEventListener("click", (e)=>{
    const c = e.target.closest(".chip"); if(!c) return;
    spendPreset = c.dataset.v;
    syncPresetUI();
    recalc();
  });

  // Stress UI
  function syncStressUI(){
    document.querySelectorAll("#stressChips .chip").forEach(c=>{
      c.classList.toggle("active", c.dataset.s === stressMode);
    });
  }
  $("stressChips").addEventListener("click", (e)=>{
    const c = e.target.closest(".chip"); if(!c) return;
    stressMode = c.dataset.s;
    syncStressUI();
    recalc();
  });

  // Enable/disable installment fields by payment method
  function syncPaymentFields(){
    const method = $("payMethod").value;
    const inst = (method === "inst0" || method === "inst_int");
    $("instMonths").disabled = !inst;
    $("apr").disabled = !(method === "inst_int");
  }

  // Save/load/reset
  $("btnSave").addEventListener("click", ()=>{ save(); recalc(); });
  $("btnLoad").addEventListener("click", ()=>{ load(); });
  $("btnReset").addEventListener("click", ()=>{ reset(); });

  // Recalc on inputs
  ids.forEach(k=>{
    $(k).addEventListener("input", ()=>{
      if(k === "payMethod"){ syncPaymentFields(); }
      recalc();
    });
    $(k).addEventListener("change", ()=>{
      if(k === "payMethod"){ syncPaymentFields(); }
      recalc();
    });
  });

  // initial
  syncPresetUI();
  syncStressUI();
  syncPaymentFields();

  // Try load saved
  const raw = localStorage.getItem("canIAffordTH_v1");
  if(raw){
    try{ setState(JSON.parse(raw)); }
    catch{ recalc(); }
  } else {
    recalc();
  }
})();
</script>
</body>
</html>